{% extends "base.html" %}

{% block title %}Cartinhas - Noel{% endblock %}

{% block extra_css %}
<style>
  .carta-card {
    height: 100%;
    transition: transform 0.2s;
  }
  .carta-card:hover {
    transform: translateY(-5px);
    box-shadow: 0 10px 20px rgba(0,0,0,0.1);
  }
  .status-badge { position: absolute; top: 10px; right: 10px; }
  .carta-nome { font-weight: bold; margin-bottom: 0.5rem; }
  .carta-presente { margin-bottom: 0.5rem; }
  .attachment-indicator { font-size: 0.9rem; }
  .pagination-info { color: #6c757d; font-size: 0.9rem; }
  .filters { background-color: #f8f9fa; padding: 1rem; border-radius: 0.5rem; margin-bottom: 1.5rem; }
  #toastContainer { position: fixed; top: 1rem; right: 1rem; z-index: 1080; }
  .badge-group { font-size: 0.72rem; line-height: 1; }
</style>
{% endblock %}

{% block content %}
<div id="toastContainer" aria-live="polite" aria-atomic="true"></div>

<div class="d-flex justify-content-between align-items-center mb-4">
  <h1>Cartinhas</h1>
  
  <div>
    {% if "ADMIN" in user.roles|map(attribute="code")|list %}
    <a href="/cartas/admin" class="btn btn-outline-danger me-2">Administrar</a>
    {% endif %}
  </div>
</div>

<!-- Filtros -->
<div class="filters">
  <div class="row">
    <div class="col-md-6">
      <form action="/cartas" method="get" class="d-flex">
        <input 
          type="text" 
          class="form-control me-2" 
          name="q" 
          placeholder="Pesquisar por nome, presente..." 
          value="{{ q or '' }}"
        >
        <button type="submit" class="btn btn-primary">Buscar</button>
      </form>
    </div>
    <div class="col-md-6">
      <div class="btn-group float-end" role="group">
        <a href="/cartas" class="btn btn-outline-secondary {% if not status_filter %}active{% endif %}">
          Todas
        </a>
        <a href="/cartas?status=disponivel" class="btn btn-outline-secondary {% if status_filter == 'disponivel' %}active{% endif %}">
          Dispon√≠veis
        </a>
        {# Mostrar Adotadas e Presente Entregue somente para ADMIN ou RH #}
        {% set role_codes = user.roles|map(attribute='code')|list if user else [] %}
        {% if 'ADMIN' in role_codes or 'RH' in role_codes %}
        <a href="/cartas?status=adotadas" class="btn btn-outline-secondary {% if status_filter == 'adotadas' %}active{% endif %}">
          Adotadas
        </a>
        <a href="/cartas?status=entregues" class="btn btn-outline-secondary {% if status_filter == 'entregues' %}active{% endif %}">
          Presente Entregue
        </a>
        {% endif %}
        {% if user %}
        <a href="/cartas?status=minhas" class="btn btn-outline-secondary {% if status_filter == 'minhas' %}active{% endif %}">
          Minhas
        </a>
        {% endif %}
      </div>
    </div>
  </div>
</div>

<!-- Lista de cartinhas -->
{% set palette = ['text-danger','text-success','text-primary'] %}
{% if cartas %}
<div class="row row-cols-1 row-cols-md-3 g-4">
  {% for carta in cartas %}
  <div class="col">
    <div class="card carta-card h-100">
      {% if carta.status == "dispon√≠vel" %}
      <span class="badge bg-success status-badge">Dispon√≠vel</span>
      {% elif carta.status == "adotada" %}
      <span class="badge bg-primary status-badge">Adotada</span>
      {% elif carta.status == "entregue" %}
      <span class="badge bg-info status-badge">Entregue</span>
      {% else %}
      <span class="badge bg-secondary status-badge">{{ carta.status }}</span>
      {% endif %}
      
      <div class="card-body">
        <div class="text-center mb-3">
          {% if carta.urlcarta %}
            {% set _u = (carta.urlcarta or '')|lower %}
            {% set _is_pdf = _u.endswith('.pdf') %}
            {% if _is_pdf %}
              {% if carta.urlcarta_pq %}
                <img src="/cartas/miniatura/{{ carta.id_carta }}"
                     alt="Miniatura do PDF da cartinha {{ carta.nome }}"
                     class="img-fluid rounded"
                     style="max-height: 120px; max-width: 100%; object-fit: cover;">
              {% else %}
                <img src="{{ url_for('static', path='pdf128.png') }}?v={{ app_version }}"
                     alt="Anexo PDF"
                     class="img-fluid rounded"
                     style="max-height: 120px; max-width: 100%; object-fit: cover;">
              {% endif %}
            {% else %}
              {% if carta.urlcarta_pq %}
                <img src="/cartas/miniatura/{{ carta.id_carta }}"
                     alt="Anexo da cartinha {{ carta.nome }}"
                     class="img-fluid rounded"
                     style="max-height: 120px; max-width: 100%; object-fit: cover;">
              {% else %}
                <img src="/cartas/anexo/{{ carta.id_carta }}"
                     alt="Anexo da cartinha {{ carta.nome }}"
                     class="img-fluid rounded"
                     style="max-height: 120px; max-width: 100%; object-fit: cover;">
              {% endif %}
            {% endif %}
          {% else %}
            <img src="{{ url_for('static', path='sem-imagem128.png') }}?v={{ app_version }}"
                 alt="Sem imagem"
                 class="img-fluid rounded"
                 style="max-height: 120px; max-width: 100%; object-fit: cover;">
          {% endif %}
        </div>
        <h5 class="card-title carta-nome">
          {{ carta.nome }}
          {% if carta.urlcarta %}
          <span class="badge rounded-pill text-bg-info ms-2 attachment-indicator" title="Possui anexo">üíå</span>
          {% endif %}
          {% if carta.grupo and carta.grupo.ds_grupo %}
          <span class="badge rounded-pill ms-2 badge-group js-group-badge"
                title="Grupo"
                data-color="{{ (carta.grupo.cor or '') if carta.grupo.cor else '' }}">
            {{ carta.grupo.ds_grupo }}
          </span>
          {% endif %}
        </h5>
        <p class="card-text carta-presente">
          <strong>Presente:</strong> {{ carta.presente }}
          <span class="ms-2 align-middle">
            <i class="fa-solid 
            fa-gift text-secondary me-1" title="gift"></i>
            {% if icons_by_id %}
              {% set icons = icons_by_id.get(carta.id_carta) %}
              {% if icons %}
                {% for icon_code in icons %}
                  {% set color = palette[(loop.index0) % 3] %}
                  <i class="fa-solid fa-{{ icon_code }} {{ color }} me-1" title="{{ icon_code }}"></i>
                {% endfor %}
              {% endif %}
            {% endif %}
          </span>
        </p>
        <p class="card-text">
          <small class="text-muted">
            {{ "Menino" if carta.sexo == "M" else "Menina" }}
            {% if carta.idade is not none %}
              &nbsp;‚Äì&nbsp;{{ carta.idade }} {{ 'ano' if carta.idade == 1 else 'anos' }}
            {% endif %}
            {% if carta.adotante_email == user.email %}
            <span class="badge bg-warning text-dark ms-2">Voc√™ adotou</span>
            {% endif %}
          </small>
        </p>
      </div>
      <div class="card-footer bg-transparent border-top-0">
        <a href="/cartas/{{ carta.id_carta }}" class="btn btn-sm btn-outline-primary">Ver detalhes</a>
        {% if carta.urlcarta %}
        {% set _u = (carta.urlcarta or '')|lower %}
        {% set _is_pdf = _u.endswith('.pdf') %}
        <a href="/cartas/anexo/{{ carta.id_carta }}" target="_blank" rel="noopener" class="btn btn-sm btn-outline-info ms-2">{{ 'Ver PDF' if _is_pdf else 'Ver imagem' }}</a>
        {% endif %}
        
        {% if carta.status == "dispon√≠vel" %}
        <form method="post" action="/cartas/adopt/{{ carta.id_carta }}" class="d-inline adopt-form">
          <button type="submit" class="btn btn-sm btn-success">Adotar</button>
        </form>
        {% elif carta.adotante_email == user.email and (not carta.entregue_bl) and carta.status != "entregue" %}
        <form method="post" action="/cartas/cancel/{{ carta.id_carta }}" class="d-inline cancel-form">
          <button type="submit" class="btn btn-sm btn-warning">Cancelar ado√ß√£o</button>
        </form>
        {% endif %}
      </div>
    </div>
  </div>
  {% endfor %}
</div>

<!-- Pagina√ß√£o -->
<div class="d-flex justify-content-between align-items-center mt-4">
  <div class="pagination-info">
    Mostrando {{ (pagination.page - 1) * pagination.per_page + 1 }} a 
    {{ [pagination.page * pagination.per_page, pagination.total]|min }} 
    de {{ pagination.total }} cartinhas
  </div>
  
  <nav aria-label="Navega√ß√£o de p√°ginas">
    <ul class="pagination">
      <li class="page-item {% if not pagination.has_prev %}disabled{% endif %}">
        <a class="page-link" href="/cartas?page={{ pagination.page - 1 }}{% if q %}&q={{ q }}{% endif %}{% if status_filter %}&status={{ status_filter }}{% endif %}">
          Anterior
        </a>
      </li>
      
      {% set start = pagination.page - 2 %}
      {% if start < 1 %}{% set start = 1 %}{% endif %}
      {% set end = pagination.page + 2 %}
      {% if end > pagination.total_pages %}{% set end = pagination.total_pages %}{% endif %}
      {% if start > end %}{% set start = end %}{% endif %}
      
      {% for p in range(start, end + 1) %}
      <li class="page-item {% if p == pagination.page %}active{% endif %}">
        <a class="page-link" href="/cartas?page={{ p }}{% if q %}&q={{ q }}{% endif %}{% if status_filter %}&status={{ status_filter }}{% endif %}">
          {{ p }}
        </a>
      </li>
      {% endfor %}
      
      <li class="page-item {% if not pagination.has_next %}disabled{% endif %}">
        <a class="page-link" href="/cartas?page={{ pagination.page + 1 }}{% if q %}&q={{ q }}{% endif %}{% if status_filter %}&status={{ status_filter }}{% endif %}">
          Pr√≥xima
        </a>
      </li>
    </ul>
  </nav>
</div>

<!-- Modais de confirma√ß√£o existentes -->
<div class="modal fade" id="confirmAdoptModal" tabindex="-1" aria-labelledby="confirmAdoptLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="confirmAdoptLabel">Confirmar ado√ß√£o</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fechar"></button>
      </div>
      <div class="modal-body">Voc√™ deseja realmente adotar esta cartinha?</div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
        <button type="button" class="btn btn-success" id="confirmAdoptBtn">Confirmar</button>
      </div>
    </div>
  </div>
</div>

<div class="modal fade" id="confirmCancelModal" tabindex="-1" aria-labelledby="confirmCancelLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="confirmCancelLabel">Confirmar cancelamento</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fechar"></button>
      </div>
      <div class="modal-body">Voc√™ deseja realmente cancelar a ado√ß√£o desta cartinha?</div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">N√£o</button>
        <button type="button" class="btn btn-warning" id="confirmCancelBtn">Sim, cancelar</button>
      </div>
    </div>
  </div>
</div>

{% else %}
<div class="alert alert-info">
  Nenhuma cartinha encontrada.
  {% if q %}
  <a href="/cartas" class="alert-link">Limpar pesquisa</a>
  {% endif %}
</div>
{% endif %}
{% endblock %}

{% block extra_js %}
<script>
  function showToast(message, opts) {
    var container = document.getElementById('toastContainer');
    if (!container) return;
    var bg = (opts && opts.bg) || 'success';
    var customStyle = (opts && opts.style) || '';
    var wrapper = document.createElement('div');
    wrapper.innerHTML = `
      <div class="toast align-items-center border-0" role="alert" aria-live="assertive" aria-atomic="true" style="${customStyle}">
        <div class="d-flex text-white ${bg ? 'bg-' + bg : ''}">
          <div class="toast-body">
            ${message}
          </div>
          <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
        </div>
      </div>`;
    var toastEl = wrapper.firstElementChild;
    container.appendChild(toastEl);
    var toast = new bootstrap.Toast(toastEl, { delay: 4000 });
    toast.show();
  }

  function hexToRgb(hex) {
    var h = (hex || '').trim();
    if (!h) return null;
    if (h[0] === '#') h = h.slice(1);
    if (h.length === 3) {
      h = h.split('').map(function(c){ return c + c; }).join('');
    }
    if (h.length !== 6) return null;
    var r = parseInt(h.slice(0,2), 16);
    var g = parseInt(h.slice(2,4), 16);
    var b = parseInt(h.slice(4,6), 16);
    if (Number.isNaN(r) || Number.isNaN(g) || Number.isNaN(b)) return null;
    return { r: r, g: g, b: b };
  }

  function idealTextColorForBg(hex) {
    var rgb = hexToRgb(hex);
    if (!rgb) return '#fff';
    var brightness = (rgb.r * 299 + rgb.g * 587 + rgb.b * 114) / 1000;
    return brightness > 155 ? '#000' : '#fff';
  }

  document.addEventListener('DOMContentLoaded', function () {
    // Aplicar cores √†s badges de grupo com contraste adequado
    document.querySelectorAll('.js-group-badge[data-color]').forEach(function(el){
      var color = (el.getAttribute('data-color') || '').trim();
      if (!color) return;
      el.style.backgroundColor = color;
      el.style.color = idealTextColorForBg(color);
    });

    // Modais existentes
    let pendingForm = null;
    const adoptModalEl = document.getElementById('confirmAdoptModal');
    const adoptConfirmBtn = document.getElementById('confirmAdoptBtn');
    const cancelModalEl = document.getElementById('confirmCancelModal');
    const cancelConfirmBtn = document.getElementById('confirmCancelBtn');

    document.querySelectorAll('form.adopt-form').forEach(function (form) {
      form.addEventListener('submit', function (e) {
        e.preventDefault();
        pendingForm = form;
        const modal = new bootstrap.Modal(adoptModalEl);
        modal.show();
      });
    });

    adoptConfirmBtn && adoptConfirmBtn.addEventListener('click', function () {
      if (pendingForm) {
        const modal = bootstrap.Modal.getInstance(adoptModalEl);
        modal && modal.hide();
        const submitBtn = pendingForm.querySelector('button[type="submit"]');
        if (submitBtn) { submitBtn.disabled = true; submitBtn.textContent = 'Adotando...'; }
        pendingForm.submit();
        pendingForm = null;
      }
    });

    // Cancelar ado√ß√£o (confirma√ß√£o)
    document.querySelectorAll('form.cancel-form').forEach(function (form) {
      form.addEventListener('submit', function (e) {
        e.preventDefault();
        pendingForm = form;
        const modal = new bootstrap.Modal(cancelModalEl);
        modal.show();
      });
    });
    cancelConfirmBtn && cancelConfirmBtn.addEventListener('click', function () {
      if (pendingForm) {
        const modal = bootstrap.Modal.getInstance(cancelModalEl);
        modal && modal.hide();
        pendingForm.submit();
        pendingForm = null;
      }
    });

    // Toasts de cancelamento baseado em query params
    var params = new URLSearchParams(window.location.search);
    if (params.get('canceled') === '1') {
      showToast('Ado√ß√£o cancelada com sucesso.', { bg: 'danger' }); // vermelho
      params.delete('canceled');
      var newUrl = window.location.pathname + (params.toString() ? '?' + params.toString() : '');
      window.history.replaceState({}, document.title, newUrl);
    }
    if (params.get('error') === 'cancel_failed') {
      // roxo customizado
      showToast('Erro ao cancelar a ado√ß√£o. Tente novamente.', { bg: '', style: 'background-color:#6f42c1;border-radius:.25rem;' });
      params.delete('error');
      var newUrl2 = window.location.pathname + (params.toString() ? '?' + params.toString() : '');
      window.history.replaceState({}, document.title, newUrl2);
    }
  });
</script>
{% endblock %}
