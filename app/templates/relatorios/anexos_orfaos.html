{% extends "base.html" %}

{% block title %}Relat√≥rio - Anexos √≥rf√£os{% endblock %}

{% block page_header %}
{% with header_title="Anexos √≥rf√£os", header_subtitle="Arquivos no bucket n√£o referenciados por cartinhas ativas" %}
  {% include "_header.html" %}
{% endwith %}
{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
  <a href="/relatorios/" class="btn btn-outline-secondary">Voltar aos Relat√≥rios</a>
</div>

<div class="toast-container position-fixed top-0 end-0 p-3" style="z-index: 1080;">
  <div id="relToast" class="toast text-bg-success" role="alert" aria-live="assertive" aria-atomic="true">
    <div class="d-flex">
      <div class="toast-body" id="relToastBody">A√ß√£o conclu√≠da.</div>
      <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Fechar"></button>
    </div>
  </div>
</div>

<div class="card">
  <div class="card-header">
    Itens listados a partir do bucket de anexos (cartas/*) que n√£o est√£o referenciados por cartinhas ativas
  </div>
  <div class="card-body">
    {% if anexos_orfaos %}
    <div class="table-responsive">
      <table class="table table-striped table-hover">
        <thead>
          <tr>
            <th>Objeto</th>
            <th>Miniatura</th>
            <th>Tamanho (bytes)</th>
            <th>Modificado em</th>
            <th class="text-end">A√ß√µes</th>
          </tr>
        </thead>
        <tbody>
          {% for item in anexos_orfaos %}
          <tr>
            <td class="text-break">{{ item.object_name }}</td>
            <td class="text-break">
              {% if item.thumb_object %}
                {{ item.thumb_object }}
              {% else %}
                <span class="text-muted">‚Äî</span>
              {% endif %}
            </td>
            <td>{{ item.size }}</td>
            <td>{{ item.last_modified }}</td>
            <td class="text-end">
              {% if item.thumb_object %}
              <button type="button" class="btn btn-sm btn-outline-secondary me-2 btn-view" data-object="{{ item.thumb_object }}" title="Ver miniatura">üñ•Ô∏è</button>
              {% endif %}
              <button type="button" class="btn btn-sm btn-outline-info me-2 btn-view" data-object="{{ item.object_name }}" title="Visualizar">üì∫</button>
              <button type="button" class="btn btn-sm btn-outline-danger btn-delete" data-object="{{ item.object_name }}" title="Apagar">üî•</button>
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
    {% else %}
    <div class="alert alert-success mb-0">Nenhum anexo √≥rf√£o encontrado.</div>
    {% endif %}
  </div>
</div>

<!-- Modal de confirma√ß√£o de exclus√£o -->
<div class="modal fade" id="confirmDeleteModal" tabindex="-1" aria-labelledby="confirmDeleteLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="confirmDeleteLabel">Confirmar exclus√£o</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fechar"></button>
      </div>
      <div class="modal-body">
        Tem certeza que deseja apagar o arquivo abaixo do MinIO?
        <pre id="deleteObjectName" class="mb-0 small"></pre>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
        <button type="button" class="btn btn-danger" id="confirmDeleteBtn">Apagar</button>
      </div>
    </div>
  </div>
</div>

{% endblock %}

{% block extra_js %}
<script>
  document.addEventListener('DOMContentLoaded', function() {
    const toastEl = document.getElementById('relToast');
    const toastBody = document.getElementById('relToastBody');
    function showToast(msg, variant) {
      if (!toastEl || !toastBody) return;
      toastBody.textContent = msg || 'A√ß√£o conclu√≠da.';
      toastEl.classList.remove('text-bg-success','text-bg-danger','text-bg-warning','text-bg-info');
      toastEl.classList.add(variant || 'text-bg-success');
      new bootstrap.Toast(toastEl, { delay: 2000 }).show();
    }

    // Visualizar (üì∫): busca URL assinada e abre em nova aba
    document.querySelectorAll('.btn-view').forEach(btn => {
      btn.addEventListener('click', async () => {
        const objectName = btn.getAttribute('data-object');
        try {
          const resp = await fetch(`/relatorios/api/object-url?object_name=${encodeURIComponent(objectName)}`, {
            method: 'GET',
            credentials: 'same-origin',
          });
          if (!resp.ok) throw new Error('Falha ao gerar URL');
          const data = await resp.json();
          window.open(data.url, '_blank', 'noopener');
        } catch (e) {
          showToast('N√£o foi poss√≠vel abrir o anexo', 'text-bg-danger');
        }
      });
    });

    // Apagar (üî•) com confirma√ß√£o
    let pendingDelete = null;
    const deleteModalEl = document.getElementById('confirmDeleteModal');
    const deleteObjectNameEl = document.getElementById('deleteObjectName');
    const confirmDeleteBtn = document.getElementById('confirmDeleteBtn');

    document.querySelectorAll('.btn-delete').forEach(btn => {
      btn.addEventListener('click', () => {
        const objectName = btn.getAttribute('data-object');
        pendingDelete = objectName;
        deleteObjectNameEl.textContent = objectName;
        const modal = new bootstrap.Modal(deleteModalEl);
        modal.show();
      });
    });

    confirmDeleteBtn.addEventListener('click', async () => {
      if (!pendingDelete) return;
      try {
        const resp = await fetch('/relatorios/api/delete-object', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          credentials: 'same-origin',
          body: JSON.stringify({ object_name: pendingDelete })
        });
        if (!resp.ok) throw new Error('Falha ao apagar');
        const modal = bootstrap.Modal.getInstance(deleteModalEl);
        modal && modal.hide();
        showToast('Arquivo apagado com sucesso!', 'text-bg-success');
        setTimeout(() => window.location.reload(), 800);
      } catch (e) {
        showToast('Erro ao apagar arquivo.', 'text-bg-danger');
      } finally {
        pendingDelete = null;
      }
    });
  });
</script>
{% endblock %}
