{% macro render_cartas_stats(stats, widget_id) %}
<div class="cartas-stats">
  <table class="table table-sm">
    <tbody>
      <tr>
        <td><strong>Total</strong></td>
        <td colspan="3">{{ stats.total }}</td>
      </tr>
      <tr>
        <td><strong>Sexo</strong></td>
        <td>M: {{ stats.sexo.M }}</td>
        <td>F: {{ stats.sexo.F }}</td>
        <td></td>
      </tr>
      <tr>
        <td><strong>Status</strong></td>
        <td colspan="3">
          {% for k, v in stats.status.items() %}
          <span class="me-3"><span class="badge bg-secondary">{{ k }}</span> {{ v }}</span>
          {% endfor %}
        </td>
      </tr>
      <tr>
        <td><strong>Grupos</strong></td>
        <td colspan="3">
          {% if stats.grupos %}
            {% for g, count in stats.grupos.items() %}
            <span class="me-3">
              <span class="badge bg-dark">{{ g }}</span>
              <span>{{ count }}</span>
            </span>
            {% endfor %}
          {% else %}
            <span class="muted">Sem dados de grupos</span>
          {% endif %}
        </td>
      </tr>
    </tbody>
  </table>

  <div class="chart-wrap" style="max-width:200px; max-height:200px;">
    <canvas id="{{ widget_id }}_pie" style="width:200px; height:200px;"></canvas>
  </div>
  <div class="chart-wrap mt-3" style="max-width:200px; max-height:200px;">
    <canvas id="{{ widget_id }}_pie_groups" style="width:200px; height:200px;"></canvas>
  </div>
</div>

<script>
(function(){
  try {
    var el = document.getElementById('{{ widget_id }}_pie');
    if (!el) return;
    var s = {{ stats|tojson }};
    var entries = Object.entries(s.status || {});
    if (!entries.length) return;
    var labels = entries.map(function(p){ return p[0]; });
    var data = entries.map(function(p){ return p[1]; });
    function renderChart(){
      new Chart(el, {
        type: 'pie',
        data: { labels: labels, datasets: [{ data: data, backgroundColor: ['#198754','#0d6efd','#0dcaf0','#6c757d','#ffc107','#dc3545'] }] },
        options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'bottom' } } }
      });
    }
    if (typeof window.Chart === 'undefined') {
      var sc = document.createElement('script');
      sc.src = 'https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js';
      sc.onload = renderChart;
      document.body.appendChild(sc);
    } else {
      renderChart();
    }
  } catch(e) { console.warn('Falha ao renderizar gráfico:', e); }
})();

(function(){
  try {
    var el = document.getElementById('{{ widget_id }}_pie_groups');
    if (!el) return;
    var s = {{ stats|tojson }};
    var entries = Object.entries(s.grupos || {});
    if (!entries.length) return;
    var labels = entries.map(function(p){ return p[0]; });
    var data = entries.map(function(p){ return p[1]; });
    var colorMap = s.grupos_colors || {};
    var fallback = ['#00C853','#64DD17','#AEEA00','#FFD600','#FFEA00','#C6FF00','#76FF03','#1DE9B6','#00E676','#B2FF59'];
    var colors = labels.map(function(lbl, idx){
      var c = colorMap && colorMap[lbl];
      if (typeof c === 'string' && c.trim()) return c.trim();
      return fallback[idx % fallback.length];
    });
    function renderChart(){
      new Chart(el, {
        type: 'pie',
        data: { labels: labels, datasets: [{ data: data, backgroundColor: colors }] },
        options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'bottom' } } }
      });
    }
    if (typeof window.Chart === 'undefined') {
      var sc = document.createElement('script');
      sc.src = 'https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js';
      sc.onload = renderChart;
      document.body.appendChild(sc);
    } else {
      renderChart();
    }
  } catch(e) { console.warn('Falha ao renderizar gráfico (grupos):', e); }
})();
</script>
{% endmacro %}


